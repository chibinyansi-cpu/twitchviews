<!doctype html>
<meta charset="utf-8" />
<title>Зрители в чате (без ботов)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Referrer-Policy" content="no-referrer" />
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()" />
<style>
  :root{ --bg:#0b0f14; --card:#111823; --text:#e8f0ff; --accent:#8ff28f; --muted:#93a1b0; --shadow:rgba(0,0,0,.35); }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.4 system-ui,Segoe UI,Roboto,Arial;display:grid;place-items:center}
  .card{background:var(--card);border-radius:16px;padding:18px 20px;min-width:280px;
        box-shadow:0 10px 30px var(--shadow), inset 0 0 0 1px rgba(255,255,255,.04)}
  .title{display:flex;gap:10px;align-items:center;margin:0 0 6px}
  .mantis{width:20px;aspect-ratio:1;display:inline-grid;place-items:center;filter:drop-shadow(0 1px 0 rgba(255,255,255,.15))}
  .title span{font-weight:700;letter-spacing:.2px}
  .count{font-size:32px;font-weight:800;letter-spacing:.5px;color:var(--accent);text-shadow:0 0 24px rgba(143,242,143,.35)}
  .sub{color:var(--muted);font-size:12px;margin-top:4px}
  .row{display:flex;justify-content:space-between;align-items:end;gap:20px}
  .list{margin-top:10px;max-height:40vh;overflow:auto;border-top:1px solid rgba(255,255,255,.06);padding-top:8px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0c1a12;color:#c9f7c9;margin:4px;font-size:12px}
  .hint{margin-top:8px;color:#8aa0b5;font-size:11px}
</style>
<div class="card">
  <h3 class="title">
    <svg class="mantis" viewBox="0 0 64 64" fill="none" aria-hidden="true">
      <path d="M13 20l8-8m30 8-8-8" stroke="#8ff28f" stroke-width="4" stroke-linecap="round"/>
      <path d="M32 18c8 0 12 10 12 18s-4 10-12 10-12-2-12-10 4-18 12-18Z" fill="#8ff28f" opacity=".25"/>
      <path d="M20 36h24" stroke="#8ff28f" stroke-width="4" stroke-linecap="round"/>
    </svg>
    <span>Зрители в чате</span>
  </h3>
  <div class="row">
    <div class="count" id="count">—</div>
    <div class="sub" id="sub">обновление…</div>
  </div>
  <div class="list" id="list"></div>
  <div class="hint">Источник: TMI chatters (участники чата). Боты отфильтрованы локально. Данных никуда не отправляется.</div>
</div>
<script>
  // Конфиденциальность: никаких куки, логов, сторонних запросов. Только прямая загрузка с tmi.twitch.tv.
  const qs = new URLSearchParams(location.search);
  const channel = (qs.get("channel")||"").trim();
  const countEl = document.getElementById("count");
  const subEl   = document.getElementById("sub");
  const listEl  = document.getElementById("list");

  if(!channel){ subEl.textContent = "Добавьте ?channel=имя_канала в URL"; }

  const KNOWN_BOTS = new Set([
    "nightbot","streamelements","streamlabs","moobot","fossabot","wizebot",
    "commanderroot","soundalerts","pretzelrocks","coebot","phantombot",
    "own3dprobot","mixitupbot","stay_hydrated_bot","streamavatars",
    "songlistbot","sergeantsecurity","scryfall","logviewer","twitchtracker",
    "pixelchat","streampc_bot","streamcord","streamegg",
  ]);
  const BOT_PATTERNS = [
    /.*bot$/i, /^bot.*/i, /.*[_\.]bot.*/i, /.*stream(labs|elements).*/i,
    /.*giveaway.*/i, /.*alert.*/i, /.*stats.*/i, /.*music.*bot.*/i
  ];
  const isBot = (n)=> KNOWN_BOTS.has(n.toLowerCase()) || BOT_PATTERNS.some(rx=>rx.test(n));

  function flatten(d){
    const c = (d && d.chatters) || {};
    const lists = ["viewers","vips","moderators","staff","admins","global_mods"];
    const all = lists.flatMap(k => c[k] || []);
    return Array.from(new Set(all)).sort((a,b)=>a.localeCompare(b,'en',{sensitivity:'base'}));
  }

  async function tick(){
    if(!channel) return;
    try{
      const r = await fetch(`https://tmi.twitch.tv/group/user/${encodeURIComponent(channel)}/chatters`, {cache:"no-store", referrerPolicy:"no-referrer"});
      if(!r.ok) throw new Error("HTTP "+r.status);
      const data = await r.json();
      const users = flatten(data);
      const humans = users.filter(u => !isBot(u));
      countEl.textContent = humans.length;
      subEl.textContent = `канал: ${channel} • локальная фильтрация • обновление раз в 15s`;
      listEl.innerHTML = humans.map(u=>`<span class="pill">@${u}</span>`).join("");
    }catch(e){
      subEl.textContent = "ошибка доступа к TMI (CORS/сеть).";
    }
  }
  tick();
  setInterval(tick, 15000);
</script>
